name: Release download stats (NumWorks.zip)

on:
  schedule:
    - cron: "15 * * * *"   # every hour at xx:15 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build stats.json for Widgy
        env:
          OWNER: EllandeVED
          REPO: NumworksApplication
          ASSET_NAME: NumWorks.zip
        run: |
          python3 - <<'PY'
          import json, os, urllib.request, datetime, pathlib

          owner = os.environ["OWNER"]
          repo = os.environ["REPO"]
          asset_name = os.environ["ASSET_NAME"]

          api = f"https://api.github.com/repos/{owner}/{repo}/releases?per_page=10"
          req = urllib.request.Request(
              api,
              headers={
                  "Accept": "application/vnd.github+json",
                  "User-Agent": f"{owner}-{repo}-release-stats"
              }
          )
          releases = json.loads(urllib.request.urlopen(req).read().decode("utf-8"))

          # Keep only published (not drafts), sorted newest first by published_at
          releases = [r for r in releases if not r.get("draft")]
          releases.sort(key=lambda r: r.get("published_at") or "", reverse=True)
          releases = releases[:2]

          def ddmmyy(iso_dt: str) -> str:
            if not iso_dt: return ""
            d = iso_dt.split("T")[0]
            y, m, dd = d.split("-")
            return f"{dd}/{m}/{y[2:]}"

          def asset_downloads(release) -> int:
            for a in release.get("assets", []):
              if a.get("name") == asset_name:
                return int(a.get("download_count", 0))
            return 0

          out_dir = pathlib.Path("site")
          out_dir.mkdir(parents=True, exist_ok=True)

          hist_path = out_dir / "history.json"
          if hist_path.exists():
            hist = json.loads(hist_path.read_text(encoding="utf-8"))
          else:
            hist = {"days": [], "releases": {}}

          today = datetime.date.today().isoformat()
          if today not in hist["days"]:
            hist["days"].append(today)
          hist["days"] = hist["days"][-7:]  # keep last 7 days

          days = hist["days"]

          latest2 = []
          for r in releases:
            tag = r.get("tag_name", "")
            total = asset_downloads(r)

            rel = hist["releases"].setdefault(tag, {
              "tag": tag,
              "published_at": r.get("published_at", ""),
              "published_date": ddmmyy(r.get("published_at", "")),
              "totals": {}
            })

            rel["published_at"] = r.get("published_at", "")
            rel["published_date"] = ddmmyy(r.get("published_at", ""))
            rel["totals"][today] = total

            # keep only last 7 totals keys
            keys = list(rel["totals"].keys())[-7:]
            rel["totals"] = {k: rel["totals"][k] for k in keys}

            # compute per-day deltas from totals
            vals = []
            prev = None
            for d in days:
              cur = rel["totals"].get(d)
              if cur is None or prev is None:
                vals.append(0)
              else:
                vals.append(max(0, cur - prev))
              prev = cur if cur is not None else prev

            latest2.append({
              "tag": tag,
              "date": rel["published_date"],
              "downloads_total": rel["totals"].get(days[-1], 0) if days else 0,
              "downloads_last7": vals
            })

          payload = {
            "updated": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
            "asset": asset_name,
            "days": days,
            "latest2": latest2
          }

          (out_dir / "history.json").write_text(json.dumps(hist, indent=2), encoding="utf-8")
          (out_dir / "stats.json").write_text(json.dumps(payload, indent=2), encoding="utf-8")
          PY

      - name: Publish to gh-pages
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Create a clean gh-pages branch content from /site
          git checkout --orphan gh-pages
          git rm -rf .
          cp -R site/* .
          touch .nojekyll

          git add .
          git commit -m "Update stats"
          git push -f origin gh-pages
